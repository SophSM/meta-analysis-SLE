---
title: "normalization"
author: "Sofia Salazar"
date: "5/16/2022"
output: html_document
---

## Setup

In this script we use `edgeR` for normalization by creating a `DGEList` object for each `rse` objects obtained from the previous `curation-2.Rmd` script.

```{bash}
qlogin
cd /mnt/Citosina/amedina/ssalazar/meta/out
module load r/4.0.2
R
```

## Libraries

```{r}
library("recount3")
library("edgeR")
```

## Normalization

Getting the curated rse objects obtained from previous `curation.Rmd`.

```{r}
SRA_projects <- scan(file = "/mnt/Citosina/amedina/ssalazar/meta/data/SRA-IDs.txt", character(), sep=",")
normalization <- readRDS("/mnt/Citosina/amedina/ssalazar/meta/out/curated_rse.xz")
```

Function for creating a `dge` object for each `rse` object.

```{r}
get_dge <- function(rse){
  dge <- DGEList(counts = assay(rse, "counts"), genes = rowData(rse))
  # Filtering out rows with zero or very low counts
  design <- model.matrix(~ DISEASE, data = colData(rse))
  keep <- filterByExpr(dge, design)
  dge <- dge[keep,,keep.lib.sizes=FALSE]
  # normalizing
  dge <- calcNormFactors(dge)
  return(dge)
}
```


Performing normalization

```{r}
for(i in 1:length(SRA_projects)){
  rse_object <- normalization[i]
  # apply the function to the rse object inside each list name
  dge_result <- lapply(rse_object, get_dge)
  # overwriting each list element for the dge object
  normalization[i] <- dge_result
}
```

## Output

The output is a list of the dge objects obtained for each study.

```{r}
saveRDS(normalization, file = "/mnt/Citosina/amedina/ssalazar/meta/out/normalized_dge.xz", compress = "xz")
```

## Session info

```{r}
sessionInfo()
# R version 4.0.2 (2020-06-22)
# Platform: x86_64-pc-linux-gnu (64-bit)
# Running under: CentOS Linux 7 (Core)

# Matrix products: default
# BLAS:   /cm/shared/apps/r/4.0.2-studio/lib64/R/lib/libRblas.so
# LAPACK: /cm/shared/apps/r/4.0.2-studio/lib64/R/lib/libRlapack.so

# locale:
 # [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 # [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 # [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 # [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 # [9] LC_ADDRESS=C               LC_TELEPHONE=C            
# [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

# attached base packages:
# [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
# [8] methods   base     

# other attached packages:
 # [1] edgeR_3.32.1                limma_3.46.0               
 # [3] recount3_1.0.7              SummarizedExperiment_1.20.0
 # [5] Biobase_2.50.0              GenomicRanges_1.42.0       
 # [7] GenomeInfoDb_1.26.7         IRanges_2.24.1             
 # [9] S4Vectors_0.28.1            BiocGenerics_0.36.1        
# [11] MatrixGenerics_1.2.1        matrixStats_0.60.0         

# loaded via a namespace (and not attached):
 # [1] Rcpp_1.0.7               locfit_1.5-9.4           lattice_0.20-41         
 # [4] Rsamtools_2.6.0          Biostrings_2.58.0        assertthat_0.2.1        
 # [7] utf8_1.2.2               BiocFileCache_1.14.0     R6_2.5.0                
# [10] RSQLite_2.2.7            httr_1.4.2               pillar_1.6.2            
# [13] zlibbioc_1.36.0          rlang_0.4.11             curl_4.3.2              
# [16] rstudioapi_0.13          data.table_1.14.0        blob_1.2.1              
# [19] R.utils_2.10.1           R.oo_1.24.0              Matrix_1.3-4            
# [22] BiocParallel_1.24.1      RCurl_1.98-1.3           bit_4.0.4               
# [25] DelayedArray_0.16.3      compiler_4.0.2           rtracklayer_1.50.0      
# [28] pkgconfig_2.0.3          tidyselect_1.1.0         tibble_3.1.3            
# [31] GenomeInfoDbData_1.2.4   XML_3.99-0.6             fansi_0.5.0             
# [34] crayon_1.4.1             dplyr_1.0.3              dbplyr_2.0.0            
# [37] withr_2.4.2              GenomicAlignments_1.26.0 bitops_1.0-7            
# [40] R.methodsS3_1.8.1        rappdirs_0.3.3           grid_4.0.2              
# [43] lifecycle_1.0.0          DBI_1.1.1                magrittr_2.0.1          
# [46] cli_3.0.1                cachem_1.0.5             XVector_0.30.0          
# [49] ellipsis_0.3.2           generics_0.1.0           vctrs_0.3.8             
# [52] tools_4.0.2              bit64_4.0.5              glue_1.4.2              
# [55] purrr_0.3.4              fastmap_1.1.0            sessioninfo_1.1.1       
# [58] memoise_2.0.0
```



