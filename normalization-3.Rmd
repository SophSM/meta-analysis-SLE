---
title: "normalization"
author: "Sofia Salazar"
date: "5/16/2022"
output: html_document
---

## Setup

In this script we use `edgeR` for normalization by creating a `DGEList` object for each `rse` objects obtained from the previous `curation-2.Rmd` script.

```{bash}
qlogin
cd /mnt/Citosina/amedina/ssalazar/meta/out
module load r/4.0.2
R
```

## Libraries

```{r}
library("recount3")
library("edgeR")
library(tidyverse)
```

## Normalization

Getting the curated rse objects obtained from previous `curation.Rmd`.

```{r}
SRA_projects <- scan(file = "/mnt/Citosina/amedina/ssalazar/meta/data/SRA-IDs.txt", character(), sep=",")
curated <- readRDS("/mnt/Citosina/amedina/ssalazar/meta/out/curated_rse.xz")
normalization <- readRDS("/mnt/Citosina/amedina/ssalazar/meta/out/curated_rse.xz")
```

Function for creating a `dge` object for each `rse` object.

```{r}
get_dge <- function(rse){
  dge <- DGEList(counts = assay(rse, "counts"), genes = rowData(rse))
  # Filtering out rows with zero or very low counts
  design <- model.matrix(~ DISEASE, data = colData(rse))
  keep <- filterByExpr(dge, design)
  dge <- dge[keep,,keep.lib.sizes=FALSE]
  # normalizing
  dge <- calcNormFactors(dge)
  return(dge)
}
```


Performing normalization

```{r}
for(i in 1:length(SRA_projects)){
  rse_object <- curated[i]
  # apply the function to the rse object inside each list name
  dge_result <- lapply(rse_object, get_dge)
  # overwriting each list element for the dge object
  normalization[i] <- dge_result
  ## MDS Plot of dge object
  #png(file = str_c("/mnt/Citosina/amedina/ssalazar/meta/out/figures/MDSplot_", names(curated)[i], ".png"), width = 800, height = 800)
   # plotMDS(dge_result[[1]], labels = rse_object[[1]]$DISEASE, col=ifelse(rse_object[[1]]$DISEASE=="CONTROL","blue","red"), top=200, gene.selection="pairwise", prior.count = 5)
    
    
  #dev.off()
    png(file = str_c("/mnt/Citosina/amedina/ssalazar/meta/out/figures/PC-MDSplot_", names(curated)[i], ".png"), width = 800, height = 800)
    plotMDS(dge_result[[1]], labels = rse_object[[1]]$DISEASE, col=ifelse(rse_object[[1]]$DISEASE=="CONTROL","blue","red"), top=200, gene.selection="common", prior.count = 5)
    
    
  dev.off()
}
```

## Output

The output is a list of the dge objects obtained for each study.

```{r}
saveRDS(normalization, file = "/mnt/Citosina/amedina/ssalazar/meta/out/normalized_dge.xz", compress = "xz")
```

## Session info

```{r}
# sessionInfo()
# R version 4.0.2 (2020-06-22)
# Platform: x86_64-pc-linux-gnu (64-bit)
# Running under: CentOS Linux 7 (Core)

# Matrix products: default
# BLAS:   /cm/shared/apps/r/4.0.2-studio/lib64/R/lib/libRblas.so
# LAPACK: /cm/shared/apps/r/4.0.2-studio/lib64/R/lib/libRlapack.so

# locale:
 # [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 # [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 # [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 # [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 # [9] LC_ADDRESS=C               LC_TELEPHONE=C            
# [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

# attached base packages:
# [1] parallel  stats4    stats     graphics  grDevices utils     datasets 
# [8] methods   base     

# other attached packages:
 # [1] forcats_0.5.1               stringr_1.4.0              
 # [3] dplyr_1.0.3                 purrr_0.3.4                
 # [5] readr_1.4.0                 tidyr_1.1.2                
 # [7] tibble_3.1.3                ggplot2_3.3.5              
 # [9] tidyverse_1.3.0             edgeR_3.32.1               
# [11] limma_3.46.0                recount3_1.0.7             
# [13] SummarizedExperiment_1.20.0 Biobase_2.50.0             
# [15] GenomicRanges_1.42.0        GenomeInfoDb_1.26.7        
# [17] IRanges_2.24.1              S4Vectors_0.28.1           
# [19] BiocGenerics_0.36.1         MatrixGenerics_1.2.1       
# [21] matrixStats_0.60.0         

# loaded via a namespace (and not attached):
 # [1] httr_1.4.2               jsonlite_1.7.2           bit64_4.0.5             
 # [4] R.utils_2.10.1           modelr_0.1.8             assertthat_0.2.1        
 # [7] BiocFileCache_1.14.0     blob_1.2.1               cellranger_1.1.0        
# [10] GenomeInfoDbData_1.2.4   Rsamtools_2.6.0          sessioninfo_1.1.1       
# [13] pillar_1.6.2             RSQLite_2.2.7            backports_1.2.1         
# [16] lattice_0.20-41          glue_1.4.2               XVector_0.30.0          
# [19] rvest_0.3.6              colorspace_2.0-2         Matrix_1.3-4            
# [22] R.oo_1.24.0              XML_3.99-0.6             pkgconfig_2.0.3         
# [25] broom_0.7.9              haven_2.3.1              zlibbioc_1.36.0         
# [28] scales_1.1.1             BiocParallel_1.24.1      generics_0.1.0          
# [31] ellipsis_0.3.2           cachem_1.0.5             withr_2.4.2             
# [34] cli_3.0.1                readxl_1.3.1             magrittr_2.0.1          
# [37] crayon_1.4.1             memoise_2.0.0            R.methodsS3_1.8.1       
# [40] fs_1.5.0                 fansi_0.5.0              xml2_1.3.2              
# [43] tools_4.0.2              data.table_1.14.0        hms_1.1.0               
# [46] lifecycle_1.0.0          reprex_1.0.0             munsell_0.5.0           
# [49] locfit_1.5-9.4           DelayedArray_0.16.3      Biostrings_2.58.0       
# [52] compiler_4.0.2           rlang_0.4.11             grid_4.0.2              
# [55] RCurl_1.98-1.3           rstudioapi_0.13          rappdirs_0.3.3          
# [58] bitops_1.0-7             gtable_0.3.0             DBI_1.1.1               
# [61] curl_4.3.2               R6_2.5.0                 lubridate_1.7.9.2       
# [64] GenomicAlignments_1.26.0 rtracklayer_1.50.0       fastmap_1.1.0           
# [67] bit_4.0.4                utf8_1.2.2               stringi_1.6.2           
# [70] Rcpp_1.0.7               vctrs_0.3.8              dbplyr_2.0.0            
# [73] tidyselect_1.1.0
```



