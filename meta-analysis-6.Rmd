---
title: "meta-analysis"
author: "Sofia Salazar"
date: "5/17/2022"
output: html_document
---

## Setup

This script is used to perform a Meta-analysis of the studies in the `SRA-IDs.txt` file.

```{bash}
qlogin
cd /mnt/Citosina/amedina/ssalazar/meta/out
module load r/4.0.2
module load pandoc/2.9.2
R
```

## Libraries

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(knitr)
library(ComplexHeatmap)
library(metafor)
library(pheatmap)
library(RColorBrewer)
library(meta)
library("MetaVolcanoR")
library(ggrepel)
library("biomaRt")
```

## Read data

```{r}
#full_tables <- read_csv("/mnt/Citosina/amedina/ssalazar/meta/out/batch/merged_protein_coding.csv")
full_tables <- read_csv("/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/merged_protein_coding.csv")
colnames(full_tables)
# rse_curated <- readRDS("/mnt/Citosina/amedina/ssalazar/meta/out/corrected_rse.xz")
SRA_info <- read_csv("/mnt/Citosina/amedina/ssalazar/meta/out/summary.csv")
SRA_info<-SRA_info %>% remove_rownames %>% column_to_rownames(var="SRA")
SRA_info2<-read_csv("/mnt/Citosina/amedina/ssalazar/meta/out/summary.csv")

SRA_info <- SRA_info%>%slice(c(1, 3, 5, 6,7, 8)) # SELECTED STUDIES
SRA_info2 <- SRA_info2%>%slice(c(1, 3, 5, 6,7, 8)) # SELECTED STUDIES
```

Filtering genes by selecting only protein coding genes in the human genome using biomaRt.

```{r}
tab <- full_tables[!duplicated(full_tables$ID),]
mart <- useMart(biomart="ensembl", dataset="hsapiens_gene_ensembl")
all_genes <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol","transcript_biotype"), 
                          filters = c("ensembl_gene_id"), 
                          values = tab$ID,
                          #values = list(biotype=c("protein_coding")), 
                          mart = mart)
all_genes<-all_genes[all_genes$transcript_biotype == "protein_coding", ]
genes_emb <- tab$gene_name %in% all_genes$hgnc_symbol
```

## p-Values

We first check pvalues histograms.

```{r}
# with different normalization methods 
outdir = "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/figures/"
FC <- str_subset(colnames(full_tables),"logFC")
# Genes with a adjusted p value
adjp <- full_tables %>%
  filter(gene_name != "NA") %>%
  gather("SRA"  ,"adjP",-gene_name) %>%
  filter(SRA %in% str_subset(colnames(full_tables),"adj.P.Val|padj")) %>%
  mutate(SRA=gsub(".*_","",SRA))
adjp$adjP <- as.numeric(adjp$adjP)
#pdf("Pvalues.pdf",width = 8,height = 6)
png(file = paste0(outdir,"adj-pvalue-histogram.png"), width = 800, height = 800)
adjp %>%    
  group_by(SRA) %>%
  ggplot( aes(x=adjP, fill=SRA)) +
  geom_histogram( color="#e9ecef", alpha=0.6) + #position = 'identity'
  geom_vline(xintercept=0.05, linetype="dashed", color = "red") +
  theme_bw(16) +
  xlab("adjusted p-value") +
  ylab("Frequency") +
  facet_wrap(~SRA, scales = "free_y") 
dev.off()
```

```{r}
# log fold change
logFC <- full_tables %>%
  filter(gene_name != "NA") %>%
  gather("SRA"  ,"logFC",-gene_name) %>%
  filter(SRA %in% str_subset(colnames(full_tables),"logFC|log2FoldChange")) %>% 
  mutate(SRA=gsub(".*_","",SRA))
logFC$logFC <- as.numeric(logFC$logFC)
png(file = paste0(outdir,"logFC-histogram.png"), width = 800, height = 800)
logFC %>%    
  group_by(SRA) %>%
  ggplot( aes(x=logFC, fill=SRA)) +
  geom_histogram( color="#e9ecef", alpha=0.6) + #position = 'identity'
  geom_vline(xintercept=0, linetype="dashed", color = "red") +
  theme_bw(16) +
  xlab("logFC") +
  ylab("Frequency") +
  facet_wrap(~SRA, scales = "free_x") 
dev.off()
# recovering logFC values from genes with p value less than 0.05 
adj_pvalue <- 0.05
# ap <- left_join(adjp,logFC,by = c("gene_name" = "gene_name", "SRA" = "SRA"))
# ap <- filter(ap,adjP < adj_pvalue)
# ap <-dplyr::select(ap, -adjP) # select all columns except adjP
# u <- ap[!duplicated(ap$gene_name), ]
# spread <- spread(u, SRA,logFC) %>% 
  # replace(is.na(.), 0)
# ap <- spread

ap <- left_join(adjp,logFC,by = c("gene_name" = "gene_name", "SRA" = "SRA")) %>%
  filter(adjP < adj_pvalue) %>% 
  dplyr::select(-adjP) %>% 
  spread(SRA,logFC) %>% 
  replace(is.na(.), 0)
ap

# selecting up regulated genes
up <- ap %>%
  mutate_at(vars(-gene_name),list(~if_else( .>0, 1, 0)))
  
down <- ap %>%
  mutate_at(vars(-gene_name),list(~if_else( .<0, 1, 0)))

### UPREGULATED GENES

m <- make_comb_mat(up,mode = "distinct")
#m <- m[comb_degree(m) >= 1]
m <- m[comb_degree(m) >= 2 | comb_degree(m) == 1]
#pdf("upsetUP.pdf",width = 14,height = 6)

outdir = "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/figures/"
png(file = paste0(outdir,"UpSet-plot-upregulated.png"), width = 800, height = 800)
ht <- draw(UpSet(m,
      pt_size = unit(5, "mm"), 
      lwd = 3,
      comb_col = c("red", "#5c5c5c","#5c5c5c","#5c5c5c", "black","blue")[comb_degree(m)])
      #order.by = "freq"
    )
od = column_order(ht)
cs = comb_size(m)
decorate_annotation("intersection_size", {
    grid.text(cs[od], x = seq_along(cs), y = unit(cs[od], "native") + unit(2, "pt"), 
        default.units = "native", just = "bottom", gp = gpar(fontsize = 12))
})
dev.off()

comb_size(m)
sample(up$gene_name[extract_comb(m,"10110")],)
q
### DOWNREGULATED GENES

m <- make_comb_mat(down,mode = "distinct")
#m <- m[comb_degree(m) >= 1]
m <- m[comb_degree(m) >= 2 | comb_degree(m) == 1] 
#pdf("upsetDOWN.pdf",width = 14,height = 6)
png(file = paste0(outdir,"UpSet-plot-downregulated.png"), width = 800, height = 800)
ht <- draw(UpSet(m,
      pt_size = unit(4, "mm"), 
      lwd = 3,
      comb_col = c("blue", "#5c5c5c","#5c5c5c","#5c5c5c", "black","red")[comb_degree(m)])
      #order.by = "freq"
    )
od = column_order(ht)
cs = comb_size(m)
decorate_annotation("intersection_size", {
    grid.text(cs[od], x = seq_along(cs), y = unit(cs[od], "native") + unit(2, "pt"), 
        default.units = "native", just = "bottom", gp = gpar(fontsize = 12))
})
dev.off()
comb_size(m)
sample(up$gene_name[extract_comb(m,"10111")],)
```

## Meta-analysis for a single gene

We first calculate the Standard error using confidence intervals

```{r}
CI.R <- str_subset(colnames(full_tables),"CI.R")
CI.L <- str_subset(colnames(full_tables),"CI.L")
for(i in 1:length(CI.R)) {
  full_tables[str_c("SE_",gsub(".*_","",CI.R))] <- (full_tables[,CI.R]-full_tables[,CI.L]) /(2*1.96)
}
```

```{r}
df <- full_tables %>%
  # arrange(ID, -Depth) %>%
  filter(duplicated(ID) == FALSE)
FC <- str_subset(colnames(df),"logFC|log2FoldChange")
SE <- str_subset(colnames(df),"lfcSE_|SE_")
SRA <- gsub(".*_","",FC)
## Function to perform a meta-analysis per gene
meta.plot <- function(gs){
  gene <-  df[which(df$gene_name == gs),]
  #gene <-  na.omit(full_tables[full_tables$gene_name == gs,])
  gene <- gene[!is.na(gene$gene_name),]
  dat <- data.frame(
    # yi = as.numeric(gene[,FC]), # effect sizes observed (Fold change)
    # sei = as.numeric(gene[,SE]),
    # n1i = as.numeric(SRA_info2$CONTROL),
    # n2i = as.numeric(SRA_info2$SLE),
    # study = SRA_info2$SRA
    yi = as.numeric(gene[,FC][1,]), # estimate of the treatment effect
    sei = as.numeric(gene[,SE][1,]), # Standard error of treatment estimate
    n1i = as.numeric(SRA_info$CONTROL), # number of controls per study
    n2i = as.numeric(SRA_info$SLE)
  )

  dat <- escalc(measure="ZCOR", yi=yi,sei=sei,n1i=n1i,n2i=n2i, data = dat) # first obtain a set of effect size estimates with their corresponding sampling variances


## the random-effects model is fitted with rma(yi, vi, data = dat). Restricted maximum-likelihood estimation is used by default when estimating Ï„2 (the REML estimator is approximately unbiased and quite efficient
  
  #res <- metafor::rma(yi, sei=sei,n1i=n1i,n2i=n2i, data=dat)
  #funnel(res)
  #forest(res,slab = SRA, main=unique(gene$gene_name))
#dev.off()

  dat$study <- SRA_info2$SRA
  m1 <- metagen(TE = yi, 
                  seTE = sei, 
                  studlab = study, 
                  n.e = n2i, 
                  n.c = n1i, 
                  data = dat,
                  method.tau = "REML", 
                  prediction = TRUE,
                  sm= "MD",
                  fixed = FALSE)
  forest(m1,
       col.diamond = "blue",
       leftcols = c("study"),
       #rightcols = c("ci", "w.random"),
       leftlabs =  c("Study","logFC","se",NA,NA),
       colgap.left = unit(5,"mm"),
       label.e = "SLE",
       colgap.studlab = unit(-10,"mm"),
       ff.study.label = "bold",
       just = "center",
       xlab = gs,
       prediction = TRUE)
}

```

## Meta-analysis for all genes

Saving the results in a new dataframe.

```{r}
datos <- df %>% drop_na(gene_name)
meta <- data.frame(genes = 0,
                   TE.random = 0,
                   pval.random = 0,
                   tau2 = 0,
                   I2 = 0,
                   pval.Q = 0,
                   num_exp=0)
# meta <- data.frame(genes = 0,
#                    QEp=0,
#                    estimate=0,
#                    pval=0,
#                    se=0,
#                    H2=0,
#                    tau2=0,
#                    I2=0,
#                    n-um_exp=0)
gm <- (datos$gene_name)
datos[datos == 0] <- NA
length(gm) 
for (i in gm) { 
  gene <- df[which(datos$gene_name == i),]
  dat <- data.frame(
    yi = as.numeric(gene[,FC][1,]), # estimate of the treatment effect
    sei = as.numeric(gene[,SE][1,]), # Standard error of treatment estimate
    n1i = as.numeric(SRA_info$CONTROL), # number of controls per study
    n2i = as.numeric(SRA_info$SLE) # number on SLE patients per study
  )
  dat$study <- rownames(SRA_info)
  if(sum(rowSums(is.na(dat)) >0) == 0){
  # meta analysis with random models "REML"
  # https://www.rdocumentation.org/packages/meta/versions/4.9-6/topics/metagen
  m1 <- metagen(TE = yi, 
                  seTE = sei, 
                  studlab = study, 
                  n.e = n2i, 
                  n.c = n1i, 
                  data = dat,
                  method.tau = "REML", 
                  prediction = TRUE,
                  sm= "MD",
                  control=list(stepadj=0.5, maxiter=10000), # decreasing step length
                  fixed = FALSE)
  num_exp <- sum(!is.na(dat$yi))
  meta <- rbind(meta,
                c(i, m1$TE.random,m1$pval.random,m1$tau2,m1$I2,m1$pval.Q,num_exp))
  }
}


# Numeric values
meta <- meta[-1,]
metau <- meta[!duplicated(meta$gene),]
metau <- metau[-1,]
rownames(metau) <- metau$gene
metau <- metau[,-1] %>% mutate_all(as.numeric)
# FDR (false discovery rate) correction
metau$qval.random <- p.adjust(metau$pval.random,method="fdr")
metau$qval.Q <- p.adjust(metau$pval.Q, method = "fdr")
# head(metau[,1])

```

### Output of full genes meta-analysis

```{r}
write.csv(metau, file ="/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/meta-analysis-6.csv")
```

```{r}
meta <- read_csv("/mnt/Citosina/amedina/ssalazar/meta/out/meta-analysis-6.csv")
### Distribution of statistics 
outdir = "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/figures/"
png(file= paste0(outdir,"distribution-stats-full.png"), width = 800, height = 800)
  bqval <- ggplot(meta) +
    aes(x = qval.random) +
    geom_histogram(bins = 55L, fill = "#c45a75") +
    labs(x = "q-value from REML") +
    theme_classic()
  bq <- ggplot(meta) +
    aes(x = qval.Q) +
    geom_histogram(bins = 55L, fill = "#c45a75") +
    labs(x = "q-value for Q test") +
    theme_classic()
  bte <- ggplot(meta) +
    aes(x = TE.random) +
    geom_histogram(bins = 55L, fill = "#c45a75") +
    labs(x = "Estimate values") +
    theme_classic()
  btau <- ggplot(meta) +
    aes(x = tau2) +
    geom_histogram(bins = 55L, fill = "#c45a75") +
    labs(x = "Tau2") +
    theme_classic()
  bi2 <- ggplot(meta) +
    aes(x = I2) +
    geom_histogram(bins = 55L, fill = "#c45a75") +
    labs(x = "I2") +
    theme_classic()
  ggpubr::ggarrange(bqval,bq,bte,btau,bi2,
                  nrow =2,
                  ncol =3)
dev.off()
### Selecting genes with less than 5% probability that it is a false positive
qval_cutoff <- 0.05
genesqval <- meta %>% 
  filter(meta$qval.random <= qval_cutoff & I2 < 0.60 & num_exp > 1) %>% 
  arrange(TE.random)
genesqval
# kable(c(head(genesqval),tail(genesqval)), caption = "Meta-analysis")

### logFC values from selected genes
topgenes <- full_tables %>% 
  filter(full_tables$gene_name %in% genesqval$X1) %>% 
  dplyr::select(gene_name,contains("logFC"))
## as dataframe
topgenes <- column_to_rownames(topgenes,"gene_name")
# scaling data
topgenes <- scale(topgenes)
write.csv(topgenes, file ="/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/meta-logFC-topgenes.csv")

color <- rev(colorRampPalette(brewer.pal(n = 11, name = "RdBu"))(15))
breaks <- c(seq(min(topgenes,na.rm = T),-0.1,length.out = 7),0,seq(0.1,max(topgenes,na.rm = T),length.out = 7))
```

### MetaVolcano

Using [Metavolcano](https://www.bioconductor.org/packages/release/bioc/vignettes/MetaVolcanoR/inst/doc/MetaVolcano.html) funcions to create a volcano plot with DE genes

We first need to create a list with tables. Each table contains information about gene `Symbol`, `Log2FC`, `pvalue`, `CI.L`, `CI.R` per experiment.

```{r}
# colnames 
df <- tibble(x=head(colnames(tab),-2))%>% 
  separate(x, c("type", "SRA"), "_") %>% 
  add_column(pos = 1:nrow(.))
df$SRA[1] <- "Gene"
# list
split_df <- function(i){
  df <- data.frame(
  gene_name = unique(tab$gene_name)[genes_emb],
                  tab[genes_emb,which(df$SRA == i)]
                   )
  colnames(df) <- c( "Symbol", "Log2FC",  "pvalue", "CI.L", "CI.R") #, "logFC.SE")
  as.data.frame(df)
}
diffexplist <- lapply(sort(unique(df$SRA)[-1]), split_df)
names(diffexplist) <- sort(unique(df$SRA)[-1])
# write_csv(as.data.frame(diffexplist), file= "/mnt/Citosina/amedina/ssalazar/meta/out/diffexplist.csv")
saveRDS(diffexplist, file= "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/diffexplist_protein_coding.xz")
```

```{r}
plot_rem <- function(meta_diffexp, jobname, outputfolder, genecol, metathr) {
    meta_res$randomPadj <- p.adjust(meta_diffexp$randomP, "BH")
    irandomp <- 0.05
    meta_res %>%
        dplyr::mutate(signcon2 = ifelse(`randomP` <= irandomp, signcon, NA)) %>%
	dplyr::mutate(Ci.ub = ifelse(`randomP` <= irandomp, randomCi.ub, NA)) %>%
	dplyr::mutate(Ci.lb = ifelse(`randomP` <= irandomp, randomCi.lb, NA)) %>%
	dplyr::filter(`randomP` <  quantile(meta_res[['randomP']], 0.6)) -> meta_res2
    png(file= paste0(outdir,"rem_metavolcano.png"), width = 1000, height = 1000)
        ggplot(dplyr::arrange(meta_res2, abs(randomSummary)),
        aes(x = randomSummary, y = -log10(randomPadj), color = signcon2, 
	    text = !!rlang::sym('Symbol'))) +
        geom_point(size = 0.6) +
	scale_color_gradient2(midpoint=0, low="#195696", mid="white", 
			      high="red", na.value = "grey80") +
	labs(x = "Summary Fold-change",
	     y = "-log10(Summary padj-value)",
	     color = "Sign consistency") +
        geom_errorbarh(aes(xmax = Ci.ub, xmin = Ci.lb, 
			   color = signcon2)) +
        theme_classic(14) +
	theme(panel.border= element_blank()) +
	theme(axis.text.x = element_text(angle = 0, vjust = 0.5)) +
	theme(axis.line.x = element_line(color = "black", size = 0.6, 
					 lineend = "square"),
	      axis.line.y = element_line(color = "black", size = 0.6, 
					 lineend = "square"))+
          geom_label_repel(aes(label = ifelse(Symbol %in% rownames(topgenes), Symbol, "")),
                  max.overlaps = Inf,
                  box.padding = 0.5,
                  size = 4)
        dev.off()
        
}
```

Now, we implement the `MetaVolcano` funtions.

```{r}
diffexplist <-readRDS("/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/diffexplist_protein_coding.xz")
outdir = "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/figures/"
## Vote counting approach
mv <- votecount_mv(diffexp = diffexplist,
             pcriteria = "pvalue",
  foldchangecol = "Log2FC", genenamecol = "Symbol", geneidcol = NULL,
  pvalue = 0.05, foldchange = 0, metathr = 0.01, collaps = TRUE,
  jobname = "MetaVolcano", outputfolder = outdir, draw = "HTML")
# diffexplist <- read.csv("/mnt/Citosina/amedina/ssalazar/meta/out/mix2_diffexplist_protein_coding.csv")
head(mv@metaresult, 10)
# plot_mv(meta_diffexp, nstud, genecol, comb, metafc)
write_csv(as.data.frame(mv@metaresult), file= "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/vote_counting_summary.csv")
# top <- head(mv@metaresult[order(mv@metaresult$randomP),], 30)
pdf(file= paste0(outdir,"vote_metavolcano.pdf"), width = 20, height = 20)
  mv@MetaVolcano
dev.off()

####
## Combining approach

meta_degs_comb <- combining_mv(diffexp=diffexplist,
                   pcriteria='pvalue', 
                   foldchangecol='Log2FC',
                   genenamecol='Symbol',
                   geneidcol=NULL,
                   metafc='Mean',
                   metathr=0.01, 
                   collaps=T,
                   jobname="MetaVolcano_protein",
                   outputfolder=outdir,
                   draw='HTML')

write_csv(as.data.frame(meta_degs_comb@metaresult), file= "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/combining_result_protein_coding.csv")
res <- read_csv("/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/combining_result_protein_coding.csv")

## most upregulated or downregulated genes based on FoldChange that is more or less 2 and pvalue < 0.05

topgenes <- res[((res$metafc>=2) |(res$metafc<=-2)) & (res$metap <=5e-2), ]

## DEG genes based on FoldChange that is more or less 1 and pvalue < 0.05

topgenes2 <- res[((res$metafc>=1) |(res$metafc<=-1)) & (res$metap <=5e-2), ]
# ISG15
upregulated <- topgenes2[topgenes2$metafc>0,]
write_csv(as.data.frame(upregulated), file= "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/upregulated.csv")
downregulated <- topgenes2[topgenes2$metafc<0,]
write_csv(as.data.frame(downregulated), file= "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/downregulated.csv") 
###
meta_degs_rem <- rem_mv(diffexp = diffexplist, pcriteria = "pvalue",
  foldchangecol = "Log2FC", genenamecol = "Symbol", geneidcol = NULL,
  collaps = T, llcol = "CI.L", rlcol = "CI.R", vcol = NULL,
  cvar = TRUE, metathr = 0.01, jobname = "MetaVolcano",
  outputfolder = outdir, draw = "HTML")

meta_res <- meta_degs_rem@metaresult
saveRDS(meta_res, file= "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/REM_resultMetaVolcano.xz")
top <- head(meta_degs_rem@metaresult[order(meta_degs_rem@metaresult$rank),], 30)
top <- head(meta_degs_rem@metaresult, 3)

# plot with names
meta_res <- readRDS("/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/diffexplist_protein_coding.xz")
# png(file= paste0(outdir,"rem_metavolcano.png")
plot_rem(meta_res, 
               jobname="REM",
               outputfolder=outdir,
               genecol = 'Symbol', 
               metathr=0.05) +
  #geom_label_repel(aes(label = ifelse(Symbol %in% top$Symbol, Symbol, "")),
  geom_label_repel(aes(label = ifelse(Symbol %in% rownames(topgenes), Symbol, "")),
                  max.overlaps = Inf,
                  box.padding = 0.5,
                  size = 4)
dev.off()

meta_df <- meta_degs_rem@metaresult %>% 
  filter(randomP < 0.05 )
write_csv(as.data.frame(meta_df), "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/meta_rem_filtered.csv")

write_csv(as.data.frame(meta_degs_rem@metaresult), "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/meta_rem_unfiltered.csv")
```


## REM intersection

```{r}
#metaVolcanoR REM result
rem_filt <- read.csv("/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/meta_rem_filtered.csv")
rem_filt <- as.data.frame(rem_filt)
topFC <- rem_filt[((rem_filt$randomSummary>=0.5) |(rem_filt$randomSummary <= -0.5)) & ((rem_filt$signcon >=3) |(rem_filt$signcon <=-3)), ] # genes with summary folchange > 1

write_csv(as.data.frame(topFC), "/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/topFC.csv")
#REM meta
meta <- read_csv("/mnt/Citosina/amedina/ssalazar/meta/out/meta-analysis-6.csv")
colnames(meta)[1] <-  "Symbol"
top_meta <- meta[((meta$qval.random < 0.05) & ((meta$TE.random <= -0.5) | (meta$TE.random >=0-5))) ,] # with qval <0.05 and TE > or < 1

join <- inner_join(topFC, top_meta) # genes that in MetaVolcanoR REM had random summary FC more or less 1, and were consistent in more than 3 studies and in meta REM had treatment effect > or < 1/-1 and qval < 0.05 for false discovery rate


```
# Combining method
```{r}
res <- read_csv("/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/combining_result_protein_coding.csv")
top_res <- res[(res$metafc >= 1) |(res$metafc <= -1) & (res$metap < 0.05),]
topgenes <- full_tables %>% 
  filter(full_tables$gene_name %in% genesqval$X1) %>% 
  dplyr::select(gene_name,contains("logFC"))
names(topgenes)[1] <- 'Symbol'
# join2 <- inner_join(top_res, topgenes) # intersecting results from combining method and REM method with metaVolcanoR

join3 <- inner_join(top_res, top_meta)
```


## Functional enrichment analysis

```{r}
library(gprofiler2)
library(forcats)
resSig<-read.csv("/mnt/Citosina/amedina/ssalazar/meta/out/batch/selected/upregulated.csv", header = F)
resSig<-resSig %>% remove_rownames %>% column_to_rownames(var="V1")
DEG <- rownames(resSig)
genes_universe <- as.vector(na.omit(full_tables$gene_name))
gostres = gost(query = DEG, organism = "hsapiens", significant = T, 
               correction_method = "fdr", domain_scope = "custom", 
               custom_bg = genes_universe, ordered_query = TRUE)
go <- as.data.frame(gostres$result)
png(file = paste0(outdir,"enrich-results.png"),
    width = 1800, height = 800)
    gostplot(gostres, capped = FALSE, interactive = FALSE)
dev.off()
png(file = paste0(outdir,"upregulatedGO.png"),
    width = 1800, height = 800)
go %>%
  dplyr::slice(1:15) %>%
  select(p_value, term_name) %>%
  mutate(go = fct_reorder(term_name, p_value)) %>%
  ggplot( aes(x=go, y=p_value)) +
  geom_bar(stat="identity", fill="#3A68AE", alpha=.6, width=.4) +
  coord_flip() +
  labs(x = "", y = "Adjusted P-value") +
  theme_bw(base_size = 20)
dev.off()


resSig<-read.csv("/mnt/Citosina/amedina/ssalazar/meta/out/batch/downregulated.csv", header = F)
resSig<-resSig %>% remove_rownames %>% column_to_rownames(var="V1")
resSig <- resSig[-1,]
DEG <- rownames(resSig)
genes_universe <- as.vector(na.omit(full_tables$gene_name))
gostres = gost(query = DEG, organism = "hsapiens", significant = T, 
               correction_method = "fdr", domain_scope = "custom", 
               custom_bg = genes_universe, ordered_query = TRUE)
go <- as.data.frame(gostres$result)
png(file = paste0(outdir,"downregulatedGO.png"),
    width = 1800, height = 800)
go %>%
  dplyr::slice(1:15) %>%
  select(p_value, term_name) %>%
  mutate(go = fct_reorder(term_name, p_value)) %>%
  ggplot( aes(x=go, y=p_value)) +
  geom_bar(stat="identity", fill="#3A68AE", alpha=.6, width=.4) +
  coord_flip() +
  labs(x = "", y = "Adjusted P-value") +
  theme_bw(base_size = 20)
dev.off()

```

## Forest plots

```{r}
# meta forest 
png(file= paste0(outdir,"forestplot-ALDH9A1.png"), width = 800, height = 800)
  meta.plot("ALDH9A1")
dev.off()

#metaVolcanoR REM forest
draw_forest(meta_degs_rem, gene = "ALDH9A1", genecol = "Symbol", foldchangecol = "Log2FC", llcol = "CI.L", rlcol = "CI.R", jobname = "MetaVolcano", outputfolder = ".", draw = "HTML")

png(file= paste0(outdir,"forestplot-DOHH.png"), width = 800, height = 800)
  meta.plot("DOHH")
dev.off()
png(file= paste0(outdir,"forestplot-RIPK3.png"), width = 800, height = 800)
  meta.plot("RIPK3")
dev.off()
png(file= paste0(outdir,"forestplot-ACTR6.png"), width = 800, height = 800)
  meta.plot("ACTR6")
dev.off()

# combining
png(file= paste0(outdir,"forestplot-EIF5.png"), width = 800, height = 800)
  meta.plot("EIF5")
dev.off()
```
